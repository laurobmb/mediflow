{{define "head"}}
    <link rel="stylesheet" href="/static/css/admin.css">
    <link rel="stylesheet" href="/static/css/admin_layout.css">
    <style>
        .record-history-list { max-height: 600px; overflow-y: auto; padding: 5px 15px 5px 5px; border: 1px solid #E0D0F0; border-radius: 8px; background-color: #fff; }
        .record-card { background: #fdfcff; border: 1px solid #E0D0F0; border-left: 5px solid #8A2BE2; border-radius: 8px; padding: 15px 20px; margin-bottom: 15px; }
        .record-card:last-child { margin-bottom: 0; }
        .record-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0eaf5; padding-bottom: 10px; margin-bottom: 15px; font-size: 0.9em; }
        .record-doctor { color: #5A3A81; }
        .record-date { color: #555; font-weight: bold; }
        .record-content dl { margin: 0; }
        .record-content dt { font-weight: bold; color: #333; margin-top: 12px; font-size: 0.9em; text-transform: uppercase; }
        .record-content dd { margin-left: 0; margin-bottom: 10px; color: #666; white-space: pre-wrap; padding-left: 10px; border-left: 2px solid #f0eaf5;}
        .record-levels { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0eaf5; font-size: 0.85em; color: #333; display: flex; flex-wrap: wrap; gap: 15px;}
        .record-levels strong { color: #5A3A81; }
        .record-levels span { background-color: #f0eaf5; padding: 3px 8px; border-radius: 4px; }
    </style>
{{end}}

{{define "content"}}
<div class="admin-container">
        {{/* Exibe o cabeçalho correto dependendo do perfil do usuário */}}
        {{if eq .UserType "admin"}}
            {{template "_admin_header.html" .}}
        {{else if eq .UserType "terapeuta"}}
            {{template "_terapeuta_header.html" .}}
        {{end}}
    <div class="form-container">
        <h2>{{.Title}}</h2>

        {{if .Patient.ConsentGivenAt.Valid}}
            <div class="flash-message success">
                ✅ Consentimento fornecido pelo paciente em: {{.Patient.ConsentGivenAt.Time.Format "02/01/2006 às 15:04"}}
            </div>
        {{else}}
            <div class="flash-message error">
                ❌ Paciente ainda não preencheu o termo de consentimento.
            </div>
        {{end}}

        <fieldset>
            <legend>Assistente de IA</legend>
            <div id="ai-summary-controls" data-usertype="{{.UserType}}" data-patientid="{{.Patient.ID}}">
                <button id="btn-ai-summary" class="btn-submit" style="background-color: #5A3A81; width: auto; margin-bottom: 20px;">
                    Gerar Resumo com IA
                </button>
                <div id="ai-summary-container" class="ai-summary-box" style="display: none;"></div>
            </div>
        </fieldset>

        <form action="{{.Action}}" method="post">
            
            <fieldset>
                <legend>Identificação do Cliente</legend>
                <div class="form-group"><label for="client_name">Nome:</label><input type="text" id="client_name" name="client_name" value="{{.Patient.Name}}" required></div>
                <div class="form-row">
                    <div class="form-group"><label for="address_street">Endereço:</label><input type="text" id="address_street" name="address_street" value="{{.Patient.AddressStreet}}"></div>
                    <div class="form-group"><label for="address_number">Nº:</label><input type="text" id="address_number" name="address_number" value="{{.Patient.AddressNumber}}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="address_neighborhood">Bairro:</label><input type="text" id="address_neighborhood" name="address_neighborhood" value="{{.Patient.AddressNeighborhood}}"></div>
                    <div class="form-group"><label for="address_city">Cidade:</label><input type="text" id="address_city" name="address_city" value="{{.Patient.AddressCity}}"></div>
                    <div class="form-group"><label for="address_state">Estado:</label><input type="text" id="address_state" name="address_state" value="{{.Patient.AddressState}}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="phone">Telefone:</label><input type="tel" id="phone" name="phone" value="{{.Patient.Phone}}"></div>
                    <div class="form-group"><label for="mobile">Celular:</label><input type="tel" id="mobile" name="mobile" value="{{.Patient.Mobile}}"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="dob">Data de Nascimento:</label><input type="date" id="dob" name="dob" value="{{.Patient.DOB}}"></div>
                    <div class="form-group"><label for="age">Idade:</label><input type="number" id="age" name="age" value="{{.Patient.Age}}" min="0"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label for="email">E-mail:</label><input type="email" id="email" name="email" value="{{.Patient.Email}}"></div>
                    <div class="form-group"><label for="profession">Profissão:</label><input type="text" id="profession" name="profession" value="{{.Patient.Profession}}"></div>
                </div>
                 <div class="form-group">
                    <label>Contato de Emergência</label>
                    <div class="form-row">
                        <div class="form-group"><label for="emergency_contact_name">Nome:</label><input type="text" id="emergency_contact_name" name="emergency_contact_name" value="{{.Patient.EmergencyContact}}"></div>
                        <div class="form-group"><label for="emergency_contact_phone">Telefone:</label><input type="tel" id="emergency_contact_phone" name="emergency_contact_phone" value="{{.Patient.EmergencyPhone}}"></div>
                        <div class="form-group"><label for="emergency_contact_other">Outro (relação):</label><input type="text" id="emergency_contact_other" name="emergency_contact_other" value="{{.Patient.EmergencyOther}}"></div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>Avaliação de Nível Emocional e Energético (Sessão Atual)</legend>
                <div class="form-group"><label>Nível de Ansiedade (0-10):</label><div class="rating-scale">{{range seq 0 10}}<label><input type="radio" name="anxiety_level" value="{{.}}" {{if eq $.LatestRecord.AnxietyLevel .}}checked{{end}}> <span>{{.}}</span></label>{{end}}</div></div>
                <div class="form-group"><label>Nível de Raiva (0-10):</label><div class="rating-scale">{{range seq 0 10}}<label><input type="radio" name="anger_level" value="{{.}}" {{if eq $.LatestRecord.AngerLevel .}}checked{{end}}> <span>{{.}}</span></label>{{end}}</div></div>
                <div class="form-group"><label>Nível de Medo (0-10):</label><div class="rating-scale">{{range seq 0 10}}<label><input type="radio" name="fear_level" value="{{.}}" {{if eq $.LatestRecord.FearLevel .}}checked{{end}}> <span>{{.}}</span></label>{{end}}</div></div>
                <div class="form-group"><label>Nível de Tristeza (0-10):</label><div class="rating-scale">{{range seq 0 10}}<label><input type="radio" name="sadness_level" value="{{.}}" {{if eq $.LatestRecord.SadnessLevel .}}checked{{end}}> <span>{{.}}</span></label>{{end}}</div></div>
                <div class="form-group"><label>Nível de Alegria (0-10):</label><div class="rating-scale">{{range seq 0 10}}<label><input type="radio" name="joy_level" value="{{.}}" {{if eq $.LatestRecord.JoyLevel .}}checked{{end}}> <span>{{.}}</span></label>{{end}}</div></div>
                <div class="form-group"><label>Nível de Energia (0-10):</label><div class="rating-scale">{{range seq 0 10}}<label><input type="radio" name="energy_level" value="{{.}}" {{if eq $.LatestRecord.EnergyLevel .}}checked{{end}}> <span>{{.}}</span></label>{{end}}</div></div>
            </fieldset>

            <fieldset>
                <legend>Queixas e Histórico (Sessão Atual)</legend>
                <div class="form-group"><label for="main_complaint">Queixa principal:</label><textarea id="main_complaint" name="main_complaint" rows="4">{{.LatestRecord.MainComplaint}}</textarea></div>
                <div class="form-group"><label for="complaint_history">Histórico da queixa principal:</label><textarea id="complaint_history" name="complaint_history" rows="6">{{.LatestRecord.ComplaintHistory}}</textarea></div>
                <div class="form-group"><label for="signs_symptoms">Sinais e sintomas:</label><textarea id="signs_symptoms" name="signs_symptoms" rows="4">{{.LatestRecord.SignsSymptoms}}</textarea></div>
                <div class="form-group"><label for="current_treatment">Está fazendo algum tratamento?</label><textarea id="current_treatment" name="current_treatment" rows="4">{{.LatestRecord.CurrentTreatment}}</textarea></div>
            </fieldset>
            
            <fieldset>
                <legend>Notas do Médico (Sessão Atual)</legend>
                <div class="form-group"><label for="notes">Notas Gerais sobre a Sessão:</label><textarea id="notes" name="notes" rows="6">{{.LatestRecord.Notes}}</textarea></div>
            </fieldset>

            <fieldset>
                <legend>Histórico do Prontuário</legend>
                {{if .History}}
                    <div class="record-history-list">
                        {{range .History}}
                        <div class="record-card">
                            <div class="record-header">
                                <span class="record-doctor">Registrado por: <strong>{{.DoctorName}}</strong></span>
                                <span class="record-date">{{.RecordDate.Format "02/01/2006 às 15:04"}}</span>
                            </div>
                            <div class="record-content">
                                <dl>
                                    <dt>Queixa Principal:</dt><dd>{{if .MainComplaint}}{{.MainComplaint}}{{else}}N/A{{end}}</dd>
                                    <dt>Histórico da Queixa:</dt><dd>{{if .ComplaintHistory}}{{.ComplaintHistory}}{{else}}N/A{{end}}</dd>
                                    <dt>Sinais e Sintomas:</dt><dd>{{if .SignsSymptoms}}{{.SignsSymptoms}}{{else}}N/A{{end}}</dd>
                                    <dt>Tratamento Atual:</dt><dd>{{if .CurrentTreatment}}{{.CurrentTreatment}}{{else}}N/A{{end}}</dd>
                                    <dt>Notas da Sessão:</dt><dd>{{if .Notes}}{{.Notes}}{{else}}N/A{{end}}</dd>
                                </dl>
                                <div class="record-levels">
                                    <strong>Níveis (0-10):</strong>
                                    <span>Ansiedade: {{.AnxietyLevel}}</span>
                                    <span>Raiva: {{.AngerLevel}}</span>
                                    <span>Medo: {{.FearLevel}}</span>
                                    <span>Tristeza: {{.SadnessLevel}}</span>
                                    <span>Alegria: {{.JoyLevel}}</span>
                                    <span>Energia: {{.EnergyLevel}}</span>
                                </div>
                            </div>
                        </div>
                        {{end}}
                    </div>
                {{else}}
                    <p>Nenhum histórico de prontuário registrado para este paciente.</p>
                {{end}}
            </fieldset>

            <div class="form-actions">
                {{if eq .UserType "admin"}}
                    <a href="/admin/patients" class="btn-cancel">Voltar para a Lista</a>
                {{else}}
                    <a href="/terapeuta/dashboard" class="btn-cancel">Voltar ao Dashboard</a>
                {{end}}
            
                <button type="submit" class="btn-submit">Salvar e Criar Registro Histórico</button>
            </div>
        </form>
    </div>
</div>
{{end}}

{{define "scripts"}}
    <script src="/static/js/ai_summary.js"></script>
{{end}}